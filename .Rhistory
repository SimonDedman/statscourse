dplyr::across(where(is.numeric), ~ {
ggplot2::ggplot(sharkdata, ggplot2::aes(x = .x)) +
ggplot2::geom_histogram(bins = 30) +
ggplot2::labs(
title = paste("Histogram of", deparse(substitute(.x))),
x = deparse(substitute(.x)),
y = "Frequency"
) +
ggplot2::theme_minimal() +
ggplot2::ggsave(
filename = here::here("ouputs", "01_explore-clean" "histograms", paste0(deparse(substitute(.x)), "_histogram.png")),
sharkdata |>
# where columns are numeric, make histograms to expose outliers
dplyr::across(where(is.numeric), ~ {
ggplot2::ggplot(sharkdata, ggplot2::aes(x = .x)) +
ggplot2::geom_histogram(bins = 30) +
ggplot2::labs(
title = paste("Histogram of", deparse(substitute(.x))),
x = deparse(substitute(.x)),
y = "Frequency"
) +
ggplot2::theme_minimal() +
ggplot2::ggsave(
filename = here::here("ouputs", "01_explore-clean", "histograms", paste0(deparse(substitute(.x)), "_histogram.png")),
width = 6,
height = 4
)
})
ClaudeR:::claude_rstudio_addin()
load(here::here("data", "sharkdata.rda"))
# Create output directory
dir.create(here::here("outputs", "01_explore-clean", "histograms"),
recursive = TRUE, showWarnings = FALSE)
# Get numeric column names
numeric_cols <- sharkdata |>
dplyr::select(where(is.numeric)) |>
names()
# Make histogram for each numeric column to expose outliers
purrr::walk(numeric_cols, \(col_name) {
p <- ggplot2::ggplot(sharkdata, ggplot2::aes(x = .data[[col_name]])) +
ggplot2::geom_histogram(bins = 30) +
ggplot2::labs(title = paste("Histogram of", col_name),
x = col_name,
y = "Frequency") +
ggplot2::theme_minimal()
ggplot2::ggsave(
filename = here::here("outputs", "01_explore-clean", "histograms",
paste0(col_name, "_histogram.png")),
plot = p,
width = 6,
height = 4
)
})
View(sharkdata)
# Make bar plot for each character column to reveal patterns & expose outliers
# Create output directory for bar plots
dir.create(here::here("outputs", "01_explore-clean", "barplots"),
recursive = TRUE, showWarnings = FALSE
)
# Get character column names
char_cols <- sharkdata |>
dplyr::select(where(is.character)) |>
names()
# Make bar plot for each character column (factors ordered by descending frequency)
purrr::walk(char_cols, \(col_name) {
p <- ggplot2::ggplot(
sharkdata,
ggplot2::aes(x = forcats::fct_infreq(.data[[col_name]]))
) +
ggplot2::geom_bar() +
ggplot2::labs(
title = paste("Bar plot of", col_name),
x = col_name,
y = "Count"
) +
ggplot2::theme_minimal() +
ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 45, hjust = 1))
ggplot2::ggsave(
filename = here::here(
"outputs", "01_explore-clean", "barplots",
paste0(col_name, "_barplot.png")
),
plot = p,
width = 8,
height = 5
)
})
sharkdata <- sharkdata |> # 1461 to
dplyr::filter(
gear %in% c("Drumline-top", "Drumline-bottom"),
country != "USA"
)
# Map plot to visualise spatial distribution after cleaning
world <- rnaturalearth::ne_countries(scale = "medium", returnclass = "sf
")
# Map plot to visualise spatial distribution after cleaning
world <- rnaturalearth::ne_countries(scale = "medium", returnclass = "sf")
p <- ggplot2::ggplot() +
ggplot2::geom_sf(data = world, fill = "antiquewhite") +
ggplot2::geom_point(
data = sharkdata,
ggplot2::aes(x = lon, y = lat),
color = "blue",
alpha = 0.5,
size = 1
) +
ggplot2::coord_sf(
xlim = c(-100, -10),
ylim = c(-40, 40),
expand = FALSE
) +
ggplot2::labs(
title = "Shark Data Spatial Distribution After Cleaning",
x = "Longitude",
y = "Latitude"
) +
ggplot2::theme_minimal()
p
p <- ggplot2::ggplot() +
ggplot2::geom_sf(data = world, fill = "antiquewhite") +
ggplot2::geom_point(
data = sharkdata,
ggplot2::aes(x = longitude, y = latitude),
color = "blue",
alpha = 0.5,
size = 1
) +
ggplot2::coord_sf(
xlim = c(-100, -10),
ylim = c(-40, 40),
expand = FALSE
) +
ggplot2::labs(
title = "Shark Data Spatial Distribution After Cleaning",
x = "Longitude",
y = "Latitude"
) +
ggplot2::theme_minimal()
p
p <- ggplot2::ggplot() +
ggplot2::geom_sf(data = world, fill = "antiquewhite") +
ggplot2::geom_point(
data = sharkdata,
ggplot2::aes(x = longitude, y = latitude),
color = "blue",
alpha = 0.5,
size = 1
) +
ggplot2::coord_sf(
# set ranges by formula for lon/lat as per data + 5% margin
xlim = c(
min(sharkdata$longitude) - 0.05 * abs(min(sharkdata$longitude)),
max(sharkdata$longitude) + 0.05 * abs(max(sharkdata$longitude))
),
ylim = c(
min(sharkdata$latitude) - 0.05 * abs(min(sharkdata$latitude)),
max(sharkdata$latitude) + 0.05 * abs(max(sharkdata$latitude))
),
expand = FALSE
) +
ggplot2::labs(
title = "Shark Data Spatial Distribution After Cleaning",
x = "Longitude",
y = "Latitude"
) +
ggplot2::theme_minimal()
p
p <- ggplot2::ggplot() +
ggplot2::geom_sf(data = world, fill = "antiquewhite") +
ggplot2::geom_point(
data = sharkdata,
ggplot2::aes(x = longitude, y = latitude),
color = "blue",
alpha = 0.5,
size = 1
) +
ggplot2::coord_sf(
# set ranges by formula for lon/lat as per data + 1% margin
xlim = c(
min(sharkdata$longitude) - 0.01 * abs(min(sharkdata$longitude)),
max(sharkdata$longitude) + 0.01 * abs(max(sharkdata$longitude))
),
ylim = c(
min(sharkdata$latitude) - 0.01 * abs(min(sharkdata$latitude)),
max(sharkdata$latitude) + 0.01 * abs(max(sharkdata$latitude))
),
expand = FALSE
) +
ggplot2::labs(
title = "Shark Data Spatial Distribution After Cleaning",
x = "Longitude",
y = "Latitude"
) +
ggplot2::theme_minimal()
p
ggplot2::ggsave(
filename = here::here(
"outputs", "01_explore-clean",
"sharkdata_spatial_distribution_cleaned.png"
),
plot = p,
width = 8,
height = 5
)
??where
# Functions ####
## plot_numeric_histograms ####
#' Plot histograms for all numeric columns
#'
#' @param df Data frame to plot
#' @param output_dir Output directory path (will be created if needed)
#'
plot_numeric_histograms <- function(df, output_dir) {
dir.create(output_dir, recursive = TRUE, showWarnings = FALSE)
df_name <- deparse(substitute(df))
numeric_cols <- df |>
dplyr::select(tidyselect::where(is.numeric)) |>
names()
purrr::walk(numeric_cols, \(col_name) {
p <- ggplot2::ggplot(df, ggplot2::aes(x = .data[[col_name]])) +
ggplot2::geom_histogram(bins = 30) +
ggplot2::labs(
title = paste("Histogram of", col_name),
x = col_name,
y = "Frequency"
) +
ggplot2::theme_minimal()
ggplot2::ggsave(
filename = file.path(output_dir, paste0(df_name, "_", col_name, "_histogram.png")),
plot = p,
width = 6,
height = 4
)
})
}
## plot_character_barplots ####
#' Plot bar plots for all character columns
#'
#' @param df Data frame to plot
#' @param output_dir Output directory path (will be created if needed)
#'
plot_character_barplots <- function(df, output_dir) {
dir.create(output_dir, recursive = TRUE, showWarnings = FALSE)
df_name <- deparse(substitute(df))
char_cols <- df |>
dplyr::select(tidyselect::where(is.character)) |>
names()
purrr::walk(char_cols, \(col_name) {
p <- ggplot2::ggplot(
df,
ggplot2::aes(x = forcats::fct_infreq(.data[[col_name]]))
) +
ggplot2::geom_bar() +
ggplot2::labs(
title = paste("Bar plot of", col_name),
x = col_name,
y = "Count"
) +
ggplot2::theme_minimal() +
ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 45, hjust = 1))
ggplot2::ggsave(
filename = file.path(output_dir, paste0(df_name, "_", col_name, "_barplot.png")),
plot = p,
width = 8,
height = 5
)
})
}
## plot_spatial_map ####
#' Plot spatial distribution map
#'
#' @param df Data frame with lon/lat columns
#' @param output_path Full output file path
#' @param lon_col Name of longitude column (default "longitude")
#' @param lat_col Name of latitude column (default "latitude")
#' @param title Plot title
#'
plot_spatial_map <- function(df,
output_path,
lon_col = "longitude",
lat_col = "latitude",
title = "Spatial Distribution") {
dir.create(dirname(output_path), recursive = TRUE, showWarnings = FALSE)
world <- rnaturalearth::ne_countries(scale = "medium", returnclass = "sf")
lon_vals <- df[[lon_col]]
lat_vals <- df[[lat_col]]
p <- ggplot2::ggplot() +
ggplot2::geom_sf(data = world, fill = "antiquewhite") +
ggplot2::geom_point(
data = df,
ggplot2::aes(x = .data[[lon_col]], y = .data[[lat_col]]),
color = "blue",
alpha = 0.5,
size = 1
) +
ggplot2::coord_sf(
xlim = c(
min(lon_vals) - 0.01 * abs(min(lon_vals)),
max(lon_vals) + 0.01 * abs(max(lon_vals))
),
ylim = c(
min(lat_vals) - 0.01 * abs(min(lat_vals)),
max(lat_vals) + 0.01 * abs(max(lat_vals))
),
expand = FALSE
) +
ggplot2::labs(
title = title,
x = "Longitude",
y = "Latitude"
) +
ggplot2::theme_minimal()
ggplot2::ggsave(
filename = output_path,
plot = p,
width = 8,
height = 5
)
}
# Shark data ####
## Load data ####
load(here::here("data", "sharkdata.rda"))
## Explore numeric columns ####
plot_numeric_histograms(
sharkdata,
here::here("outputs", "01_explore-clean", "histograms")
)
## Explore character columns ####
plot_character_barplots(
sharkdata,
here::here("outputs", "01_explore-clean", "barplots")
)
## Filter data ####
sharkdata <- sharkdata |> # 1461 to 1364
dplyr::filter(
gear %in% c("Drumline-top", "Drumline-bottom"),
country != "USA"
)
## Spatial distribution ####
plot_spatial_map(
sharkdata,
here::here("outputs", "01_explore-clean", "sharkdata_spatial_distribution_cleaned.png"),
title = "Shark Data Spatial Distribution After Cleaning"
)
View(sharkdata)
# Static Explanatory Data (expvarstat) ####
## Load data ####
load(here::here("data", "expvarstat.rda"))
## Explore numeric columns ####
plot_numeric_histograms(
expvarstat,
here::here("outputs", "01_explore-clean", "histograms")
)
View(expvarstat)
## Explore character columns ####
plot_character_barplots(
expvarstat,
here::here("outputs", "01_explore-clean", "barplots")
)
## Spatial distribution ####
plot_spatial_map(
expvarstat,
here::here("outputs", "01_explore-clean", "expvarstat_spatial_distribution.png"),
title = "Static Explanatory Data Spatial Distribution"
)
# Dynamic Explanatory Data (expvardy) ####
## Load data ####
load(here::here("data", "expvardy.rda"))
## Explore numeric columns ####
plot_numeric_histograms(
expvardy,
here::here("outputs", "01_explore-clean", "histograms")
)
## Explore character columns ####
plot_character_barplots(
expvardy,
here::here("outputs", "01_explore-clean", "barplots")
)
## Spatial distribution ####
plot_spatial_map(
expvardy,
here::here("outputs", "01_explore-clean", "expvardy_spatial_distribution.png"),
title = "Dynamic Explanatory Data Spatial Distribution"
)
# Join tables ####
sharkdata <- sharkdata |> # 1364*26 -> 1364*
dplyr::left_join(
expvarstat,
by = c("latitude", "longitude")
) |>
dplyr::left_join(
expvardy,
by = c("event_dt", "event_ts", "latitude", "longitude")
)
View(sharkdata)
expvarstatunique <- expvarstat |> # remove dupes, nrow 31473 before; 30055 after; 1418 removed. 159 vars before, 140 after, 19 removed
group_by(latitude, longitude) |>
summarise(across(where(is.numeric), mean, na.rm = TRUE),
across(where(~ is.character(.) | is.POSIXt(.)), first)) |> # library(lubridate)
mutate(across(where(is.numeric), ~ ifelse(is.nan(.), NA, .)), #convert NaN to NA. POSIX needs lubridate
across(where(~ is.character(.)), ~ ifelse(is.nan(.), NA, .))) |>  # https://community.rstudio.com/t/why-does-tidyrs-fill-work-with-nas-but-not-nans/25506/5
ungroup
expvarstatunique <- expvarstat |> # remove dupes, nrow 31473 before; 30055 after; 1418 removed. 159 vars before, 140 after, 19 removed
group_by(latitude, longitude) |>
summarise(across(where(is.numeric), mean, na.rm = TRUE),
across(where(~ is.character(.) | is.POSIXt(.)), first)) |> # library(lubridate)
mutate(across(where(is.numeric), ~ ifelse(is.nan(.), NA, .)), #convert NaN to NA. POSIX needs lubridate
across(where(~ is.character(.)), ~ ifelse(is.nan(.), NA, .))) |>  # https://community.rstudio.com/t/why-does-tidyrs-fill-work-with-nas-but-not-nans/25506/5
ungroup()
expvarstatunique <- expvarstat |> # remove dupes, nrow 31473 before; 30055 after; 1418 removed. 159 vars before, 140 after, 19 removed
dplyr::group_by(latitude, longitude) |>
dplyr::summarise(dplyr::across(tidyselect::where(is.numeric), mean, na.rm = TRUE),
across(tidyselect::where(~ is.character(.) | is.POSIXt(.)), first)) |> # library(lubridate)
dplyr::mutate(dplyr::across(tidyselect::where(is.numeric), ~ ifelse(is.nan(.), NA, .)), #convert NaN to NA. POSIX needs lubridate
dplyr::across(tidyselect::where(~ is.character(.)), ~ ifelse(is.nan(.), NA, .))) |>  # https://community.rstudio.com/t/why-does-tidyrs-fill-work-with-nas-but-not-nans/25506/5
dplyr::ungroup()
expvarstatunique <- expvarstat |> # remove dupes, nrow 31473 before; 30055 after; 1418 removed. 159 vars before, 140 after, 19 removed
dplyr::group_by(latitude, longitude) |>
dplyr::summarise(dplyr::across(tidyselect::where(is.numeric), mean, na.rm = TRUE),
across(tidyselect::where(~ is.character(.) | is.POSIXt(.)), dplyr::first())) |> # library(lubridate)
dplyr::mutate(dplyr::across(tidyselect::where(is.numeric), ~ ifelse(is.nan(.), NA, .)), #convert NaN to NA. POSIX needs lubridate
dplyr::across(tidyselect::where(~ is.character(.)), ~ ifelse(is.nan(.), NA, .))) |>  # https://community.rstudio.com/t/why-does-tidyrs-fill-work-with-nas-but-not-nans/25506/5
dplyr::ungroup()
expvarstatunique <- expvarstat |> # remove dupes, nrow 31473 before; 30055 after; 1418 removed. 159 vars before, 140 after, 19 removed
dplyr::group_by(latitude, longitude) |>
dplyr::summarise(dplyr::across(tidyselect::where(is.numeric), mean, na.rm = TRUE),
across(tidyselect::where(~ is.character(.) | is.POSIXt(.)), dplyr::first(.))) |> # library(lubridate)
dplyr::mutate(dplyr::across(tidyselect::where(is.numeric), ~ ifelse(is.nan(.), NA, .)), #convert NaN to NA. POSIX needs lubridate
dplyr::across(tidyselect::where(~ is.character(.)), ~ ifelse(is.nan(.), NA, .))) |>  # https://community.rstudio.com/t/why-does-tidyrs-fill-work-with-nas-but-not-nans/25506/5
dplyr::ungroup()
expvarstatunique <- expvarstat |> # remove dupes, nrow 31473 before; 30055 after; 1418 removed. 159 vars before, 140 after, 19 removed
dplyr::group_by(latitude, longitude) |>
dplyr::summarise(
dplyr::across(tidyselect::where(is.numeric), mean, na.rm = TRUE),
dplyr::across(tidyselect::where(~ is.character(.x) | is.POSIXt(.x)), dplyr::first)
) |> # library(lubridate)
dplyr::mutate(
dplyr::across(tidyselect::where(is.numeric), ~ ifelse(is.nan(.x), NA, .x)), # convert NaN to NA. POSIX needs lubridate
dplyr::across(tidyselect::where(~ is.character(.x)), ~ ifelse(is.nan(.x), NA, .x))
) |> # https://community.rstudio.com/t/why-does-tidyrs-fill-work-with-nas-but-not-nans/25506/5
dplyr::ungroup()
expvarstatunique <- expvarstat |> # remove dupes, nrow 31473 before; 30055 after; 1418 removed. 159 vars before, 140 after, 19 removed
dplyr::group_by(latitude, longitude) |>
dplyr::summarise(
dplyr::across(tidyselect::where(is.numeric), mean, na.rm = TRUE),
dplyr::across(tidyselect::where(~ is.character(.x) | lubridate::is.POSIXt(.x)), dplyr::first)
) |> # library(lubridate)
dplyr::mutate(
dplyr::across(tidyselect::where(is.numeric), ~ ifelse(is.nan(.x), NA, .x)), # convert NaN to NA. POSIX needs lubridate
dplyr::across(tidyselect::where(~ is.character(.x)), ~ ifelse(is.nan(.x), NA, .x))
) |> # https://community.rstudio.com/t/why-does-tidyrs-fill-work-with-nas-but-not-nans/25506/5
dplyr::ungroup()
View(expvarstat)
View(expvarstatunique)
# Shark data (sharkdata) ####
## Load data ####
load(here::here("data", "sharkdata.rda"))
## Filter data ####
sharkdata <- sharkdata |> # 1461 to 1364
dplyr::filter(
gear %in% c("Drumline-top", "Drumline-bottom"),
country != "USA"
)
sharkdatajoined <- sharkdata |> # 1364*26 -> 1364*
dplyr::left_join(
expvarstatunique,
by = c("latitude", "longitude")
) |>
dplyr::left_join(
expvardy,
by = c("event_dt", "event_ts", "latitude", "longitude")
)
View(sharkdata)
View(expvarstatunique)
expvardyunique <- expvardy |> # remove dupes, nrow 31473 before; 30055 after; 1418 removed. 159 vars before, 140 after, 19 removed
dplyr::group_by(latitude, longitude, event_dt, event_ts) |>
dplyr::summarise(
dplyr::across(tidyselect::where(is.numeric), mean, na.rm = TRUE),
dplyr::across(tidyselect::where(~ is.character(.x) | lubridate::is.POSIXt(.x)), dplyr::first)
) |> # library(lubridate)
dplyr::mutate(
dplyr::across(tidyselect::where(is.numeric), ~ ifelse(is.nan(.x), NA, .x)), # convert NaN to NA. POSIX needs lubridate
dplyr::across(tidyselect::where(~ is.character(.x)), ~ ifelse(is.nan(.x), NA, .x))
) |> # https://community.rstudio.com/t/why-does-tidyrs-fill-work-with-nas-but-not-nans/25506/5
dplyr::ungroup()
sharkdatajoined <- sharkdata |> # 1364*26 -> 1364*
dplyr::left_join(
expvarstatunique,
by = c("latitude", "longitude")
) |>
dplyr::left_join(
expvardyunique,
by = c("event_dt", "event_ts", "latitude", "longitude")
)
## Explore numeric columns ####
plot_numeric_histograms(
sharkdatajoined,
here::here("outputs", "01_explore-clean", "histograms")
)
## Explore character columns ####
plot_character_barplots(
sharkdatajoined,
here::here("outputs", "01_explore-clean", "barplots")
)
## Spatial distribution ####
plot_spatial_map(
sharkdatajoined,
here::here("outputs", "01_explore-clean", "expvardy_spatial_distribution.png"),
title = "Dynamic Explanatory Data Spatial Distribution"
)
# Save cleaned and joined data ####
usethis::use_data(sharkdatajoined, overwrite = TRUE)
